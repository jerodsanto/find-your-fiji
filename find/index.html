<!DOCTYPE html>
<html>
<head>
  <title>Find Your Fiji! What is exactly half way around the world from me?</title>
  <style type="text/css">
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #credit { position: absolute; bottom: 0; right: 0; background: #000; color: #fff; padding: 3px 5px 2px; font-size: 12px; }
    #credit a, #credit a:hover, #credit a:visited { color: white; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="credit">
    Map tiles by <a href="http://stamen.com">Stamen Design</a> (<a href="http://creativecommons.org/licenses/by/3.0">CC 3.0</a>)
  </div>
  <script src="//maps.googleapis.com/maps/api/js?key=AIzaSyDqw0UXEFyQyY3a9nLFZl5wwHZ-jKPuMjw"></script>
  <script src="//maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
  <script>
  Math.radians = function(degrees) {
    return degrees * Math.PI / 180;
  };

  Math.degrees = function(radians) {
    return radians * 180 / Math.PI;
  };

  function latDue(bearing, lat, distance) {
    var radius = 6371;
    var lat1 = Math.radians(lat);

    var lat2 = Math.asin(Math.sin(lat1)*Math.cos(distance/radius) +
      Math.cos(lat1)*Math.sin(distance/radius)*Math.cos(bearing));

    return Math.degrees(lat2);
  }

  function lngDueEast(lng, distance) {
    var bearing = 90;     // due east
    var radius = 6371;    // earth's radius in km
    var lat1 = 0;           // assume we're at the equator

    var lng1 = Math.radians(lng);

    var lat2 = Math.asin(Math.sin(lat1)*Math.cos(distance/radius) +
      Math.cos(lat1)*Math.sin(distance/radius)*Math.cos(bearing));
    var lng2 = lng1 + Math.atan2(Math.sin(bearing)*Math.sin(distance/radius)
      *Math.cos(lat1), Math.cos(distance/radius)-Math.sin(lat1)*Math.sin(lat2));

    console.log("lat1", lat1, "lat2", lat2, "lon1", lng1, "lon2", lng2);
    return Math.degrees(lng2);
  };

  var latLngList = location.hash.replace("#/", "").split(",");
  var lat = parseFloat(latLngList[0], 10);
  var lng = parseFloat(latLngList[1], 10);
  var northern = 0 < lat ? true : false;
  var endCandidates = [];

  console.log(lat, lng, northern);
  var map, start, end, line, endInterval;

  function init() {
    var layer = "watercolor";
    var bounds = new google.maps.LatLngBounds();
    var startLL = new google.maps.LatLng(lat, lng);
    var equatorLL = new google.maps.LatLng(0, lng);
    var halfwayLL = new google.maps.LatLng(0, lngDueEast(lng, 10019));
    var endLL = new google.maps.LatLng(-lat, lngDueEast(lng, 20038));
    detectWater(endLL);
    endCandidates.push(endLL);

    bounds.extend(startLL);
    bounds.extend(halfwayLL);
    bounds.extend(endLL);

    map = new google.maps.Map(document.getElementById("map"), {
      center: halfwayLL,
      zoom: 2,
      mapTypeId: layer,
      tilt: 0,
      // draggable: false,
      scrollwheel: false,
      scaleControl: false,
      streetViewControl: false,
      mapTypeControl: false,
      zoomControl: false,
      panControl: false,
      mapTypeControlOptions: {
        mapTypeIds: [layer]
      }
    });

    map.mapTypes.set(layer, new google.maps.StamenMapType(layer));
    map.fitBounds(bounds);

    start = new google.maps.Marker({
      map: map,
      position:  startLL,
      icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
    });

    function detectWater(ll) {
      var water = new Image();
      water.crossOrigin = "http://maps.googleapis.com/crossdomain.xml";
      water.src = "http://maps.googleapis.com/maps/api/staticmap?center=" + ll.toUrlValue() + "&zoom=13&size=100x100&sensor=false&visual_refresh=true&style=element:labels|visibility:off&style=feature:water|color:0x00FF00&style=feature:transit|visibility:off&style=feature:poi|visibility:off&style=feature:road|visibility:off&style=feature:administrative|visibility:off";

      var waterCanvas = document.createElement("canvas");
      waterCanvas.setAttribute("width", 100);
      waterCanvas.setAttribute("height", 100);
      waterCanvas = waterCanvas.getContext("2d");

      water.onload = function() {
        waterCanvas.drawImage(water, 0, 0, 100, 100);
        var bytes = waterCanvas.getImageData(50, 50, 1, 1).data;
        var waterColorBytes = [0, 254, 0];
        var ourColorBytes = [bytes[0], bytes[1], bytes[2]];

        console.log(bytes);

        if (bytes[1] === 254) {
          ll.isLand = false;
        } else {
          ll.isLand = true;
        }
      }
    };

    function animateLine(from, to, cb) {
      var step = 0;
      var numSteps = 250;

      var line = new google.maps.Polyline({
        path: [from, from],
        strokeColor: "#FFF",
        strokeOpacity: 0,
        icons: [{
          icon: {
            path: 'M 0,-1 0,1',
            strokeOpacity: 1,
            scale: 4
          },
          offset: "0",
          repeat: "20px"
        }],
        geodesic: true,
        map: map,
       });

      var interval = setInterval(function() {
        step += 1;

        if (step < numSteps) {
          if (!google.maps.geometry) {
            return;
          }

          var soFar = google.maps.geometry.spherical.interpolate(from, to, step / numSteps);
          line.setPath([from, soFar]);
        } else {
          clearInterval(interval);

          if (cb) {
            cb();
          }
        }
      }, 10);
    }

    endInterval = setInterval(function() {
      var lastEndPoint = endCandidates[endCandidates.length - 1];

      if (!lastEndPoint.isLand) {
        var nextLat = latDue(0, lastEndPoint.lat(), 250);
        var nextPoint = new google.maps.LatLng(nextLat, lastEndPoint.lng());
        console.log("pushing new end point!", nextPoint);
        detectWater(nextPoint);
        endCandidates.push(nextPoint);
      } else {
        clearInterval(endInterval);
      }
    }, 500);

    currentEndPoint = endLL;

    animateLine(startLL, halfwayLL, function() {
      animateLine(halfwayLL, endLL, function() {
        if (endLL.isLand) {
          new google.maps.Marker({
            map: map,
            position:  endLL,
            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
          });
        } else {
          // heading north|south!
          new google.maps.Marker({
            map: map,
            position:  endLL,
            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
          });

          var actualEndLL = endCandidates[endCandidates.length - 1];

          animateLine(endLL, actualEndLL, function() {
            new google.maps.Marker({
              map: map,
              position:  actualEndLL,
              icon: 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png'
            });
          })
        }
      });
    });
  }

  google.maps.event.addDomListener(window, "load", init);
  </script>
</body>
</html>
